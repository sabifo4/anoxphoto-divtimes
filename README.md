# Reproducible Bayesian node-dating timetree inference

In this repository, you will find a very detailed tutorial with all the steps you need to follow to reproduce the results for the timetree inference analyses we carried out as part of the following studies:

* **Quasi-Darwinian competition between biogeochemical cycle-variants by persistence selection for their geochemical effects**.
* **Evolutionary assembly of metabolism through Earth history**.

To get started, you can clone this repository on your PC and follow all the guidelines given in the various `README.md` files that you shall find inside each directory so that you can go through all the steps we carried out for timetree inference. A summary of this workflow is given below:

* Parsing and formatting the input data required to run `PAML` programs `CODEML` and `MCMCtree` ([Yang, 2007](https://pubmed.ncbi.nlm.nih.gov/17483113/)): sequence files, calibrated tree files (two calibration strategies, more details below), and control files.
* Inferring the mean evolutionary rate to specify a sensible rate prior.
* Running `PAML` programs for timetree inference:
  * Using various in-house pipelines to set up the working environment, the file structure, and the control files required to run `PAML` programs.
  * Running `CODEML` to calculate the branch lengths, the gradient, and the Hessian; required by `MCMCtree` to enable the approximate likelihood calculation [dos Reis and Yang, 2011](https://academic.oup.com/mbe/article/28/7/2161/1051613).
  * Running `MCMCtree` with the approximate likelihood calculation enabled for timetree inference. We assessed the impact that **two different calibration strategies** could have on timetree inference under both the Geometric Brownian motion (**GBM**, [Thorne et al., 1998](https://pubmed.ncbi.nlm.nih.gov/9866200/), [Yang and Rannala, 2006](https://pubmed.ncbi.nlm.nih.gov/16177230/)) and the independent-rates log-normal (**ILN**, [Rannala and Yang, 2007](https://pubmed.ncbi.nlm.nih.gov/17558967/), [Lemey et al., 2010](https://pubmed.ncbi.nlm.nih.gov/20203288/)) **relaxed-clock models**. One of the calibration strategies incorporated an additional age constraint for the Crown-Archaea excluding DPANN, what we label as `CG-ARCH-EXCLDPANN` in our calibration files and identify with tag `withArchExclDPANN` in our file structure. Those analyses where such node age is not constrained are instead labelled as `withoutArchExclDPANN` in our file structure. The analyses can be therefore summarised as follows:
    * **GBM + withArchExclDPANN**.
    * **GBM + withoutArchExclDPANN**.
    * **ILN + withArchExclDPANN**.
    * **ILN + withoutArchExclDPANN**.
* Running MCMC diagnostics for all the chains under each analysis.

To make it easier for you to navigate this GitHub repository, below you can find a summary of the content you shall find inside each directory.

## [Data formatting](00_data_formatting/README.md)

* **Molecular alignment**: we analysed the molecular alignment that had been assembled by [Moody et al. 2022](https://elifesciences.org/articles/66695): 700 taxa and 8,152 AAs. You can read the `README.md` file under [`00_data_formatting`](00_data_formatting/README.md) to reproduce all the steps that we carried out to convert their sequence data into a concatenated alignment in PHYLIP format ready to be used by `PAML` programs.
  * [**`00_raw_data/alignmnet/ind_genes`, individual filtered sequences**](00_data_formatting/00_raw_data/alignment/ind_genes): in this directory, you shall find the individual gene alignments that were generated by [Moody et al. 2022](https://elifesciences.org/articles/66695), which we used to generate our concatenated alignment.
  * [**`00_raw_data/alignmnet/ind_to_conc`, directory with formatted sequences used to generate the concatenated alignment**](00_data_formatting/00_raw_data/alignment/ind_to_conc/): you will see 57 files with one-line FASTA sequence alignments (the original 57 gene markers filtered and assembled by [Moody et al. 2022](https://elifesciences.org/articles/66695)). They were the input to the [`fasta-phylip-partitions`](https://github.com/sabifo4/fasta-phylip-partitions) pipeline, which can also be found in the [`src`](src/) directory (see section [`Alignment files`](00_data_formatting/README.md#alignment-files) to read more about how to use it). The concatenated alignment can be found inside one of the subdirectories inside the [`phylip_format` directory](00_data_formatting/00_raw_data/alignment/ind_to_conc/phylip_format/02_concatenated_alignments/ortho57_concat.aln), alongside other output files with summary stats.
  * [**`00_raw_data/alignmnet/nuc_conc`, directory with the nucleotide alignments in various formats**](00_data_formatting/00_raw_data/alignment/nuc_conc/): this nucleotide alignment was used to obtain a list of all the taxa present in the alignment, but was not used for subsequent analyses.
  * [`01_inp_data`, location of the final molecular alignment**](00_data_formatting/01_inp_data/ortho57_aln.phy): the sequence alignment in PHYLIP format used for all timetree inference analyses can be found in directory `01_inp_data`, file name [`ortho57_aln.phy`](00_data_formatting/01_inp_data/ortho57_aln.phy).
* **Phylogeny**: we used the species tree files generated by [Moody et al. 2022](https://elifesciences.org/articles/66695) (i.e., see [directory `00_data_formatting/00_raw_data/trees/constrained_sp_tt`](00_data_formatting/00_raw_data/trees/constrained_sp_tt)) to then generate a tree to manually annotate prior to including the calibrations ([`tree_detailed_taxonomy_annot`](00_data_formatting/00_raw_data/trees/tree_detailed_taxonomy_annot.tree)). You can open the `FigTree` project with the annotations by opening file [`anoxphoto_annotate_FigTree`](00_data_formatting/00_raw_data/trees/anoxphoto_annotate_FigTree), as well as the [svg figure](00_data_formatting/00_raw_data/trees/anoxphoto_annotate_FigTree.svg).
* **Calibrations**: we used the [`anoxphoto_annotate_FigTree`](00_data_formatting/00_raw_data/trees/anoxphoto_annotate_FigTree) to incorporate placeholders onto those nodes which age had to be constrained. Based on two randomly picked taxa within the clade leading to the nodes being constrained, we created files [`Calibs_anoxphoto.txt`](00_data_formatting/00_raw_data/calibs/Calibs_anoxphoto.txt) and [`Calibs_anoxphoto_withArchExclDPANN.txt`](00_data_formatting/00_raw_data/calibs/Calibs_anoxphoto_withArchExclDPANN.txt), two input files with our two calibration strategies (i.e., either the Crown-Archaea excluding DPANN node was constrained or not) that were used by our [R in-house script `Include_calibrations_MCMCtree.R`](00_data_formatting/scripts/Include_calibrations_MCMCtree.R) to generate the two input calibrated tree files for `MCMCtree`. There are intermediate files generated inside directory [`trees`](00_data_formatting/00_raw_data/trees), but only the calibrated tree files saved in directory `01_inp_data` are relevant: [`anoxphoto_withoutArchExclDPANN_calib_MCMCtree`](00_data_formatting/01_inp_data/anoxphoto_withoutArchExclDPANN_calib_MCMCtree.tree). We also generated un uncalibrated tree file, `anoxphoto_uncalib.tree`, which is used by `CODEML` to estimate the branch lengths, the gradient, and the Hessian required to approximate the likelihood calculation ([dos Reis and Yang, 2011](https://academic.oup.com/mbe/article/28/7/2161/1051613)).

## [PAML analyses](01_PAML)

Note that all the directories that you shall find inside the [`01_PAML` directory](01_PAML) have their own `README.md` file. To this end, you can navigate to each of these directories to read more about how we ran `CODEML` and `MCMCtree` when running the inference analyses under different settings (e.g., data type, calibration strategy, relaxed-clock model).

Below, you can find a short description of what you can find in each directory:

* [**`00_CODEML`**](01_PAML/00_CODEML/README.md): guidelines to infer the branch lengths, the gradient, and the Hessian with `CODEML`.
* [**`01_MCMCtree`**](01_PAML/01_MCMCtree/README.md): guidelines to run `MCMCtree` by enabling the approximate likelihood calculation ([dos Reis and Yang, 2011](https://academic.oup.com/mbe/article/28/7/2161/1051613)) under the **GBM and ILN relaxed-clock models** and our **two calibration strategies**. The directories with name `GBM` correspond to analyses under the autocorrelated-rates model and those with `ILN` under the independent-rates log-normal rates model. Inside these two directories, you will have directory `1` and directory `2`. Directory `1` contains all the relevant files for those analyses when the "Crown-Archaea excluding DPANN" node age was constrained (i.e., file names will include `withArchExclDPANN`). Directory `2`, on the contrary, will have those files generated and/or used when the "Crown-Archaea excluding DPANN" node age was not constrained (i.e., file names will include `withoutArchExclDPANN`). A total of 16 chains were run when sampling from the posterior, and so you shall find directories from `1` to `16` inside directories [`GBM/[1-2]`](01_PAML/01_MCMCtree/sum_analyses/01_posterior/GBM) and [`ILN/[1-2]`](01_PAML/01_MCMCtree/sum_analyses/01_posterior/ILN). When sampling from the prior, a total of 6 chains were run, and so you shall find directories from `1` to `6` inside directory [`CLK/[1-2]`](01_PAML/01_MCMCtree/sum_analyses/00_prior/CLK). All the plots generated as part of the MCMC diagnostics can be found under directory [`plots`](01_PAML/01_MCMCtree/plots/); tables with convergence, efficiency, and sampling diagnostics under directory [`out_RData`](01_PAML/01_MCMCtree/out_RData/); and "summary directories" [`sum_files_post`](01_PAML/01_MCMCtree/sum_files_post/) and [`sum_files_prior`](01_PAML/01_MCMCtree/sum_files_prior/) have the most relevant files generated during MCMC diagnostics when sampling from the posterior and the prior, respectively. The output tab-separated files that were used in subsequent steps of this study are the following:
  * [**Summary of estimated divergence times | `withArchExclDPANN + GBM`**](01_PAML/01_MCMCtree/sum_files_post/withArchExclDPANN_GBM_FILT_all_mean_est.tsv): this file has the estimated mean posterior divergence times (second column), 2.5% quantile (third column), and 97.5% quantile (fourth column) for those analyses ran under the GBM relaxed-clock model and when node Crown-Archaea excluding DPANN had its age constrained. Note that some chains had to be filtered out, hence the `FILT` term in the file name.
  * [**Summary of estimated divergence times | `withArchExclDPANN + ILN`**](01_PAML/01_MCMCtree/sum_files_post/withArchExclDPANN_ILN_FILT_all_mean_est.tsv): this file has the estimated mean posterior divergence times (second column), 2.5% quantile (third column), and 97.5% quantile (fourth column) for those analyses ran under the ILN relaxed-clock model and when node Crown-Archaea excluding DPANN had its age constrained. Note that some chains had to be filtered out, hence the `FILT` term in the file name.
  * [**Summary of estimated divergence times | `withoutArchExclDPANN + GBM`**](01_PAML/01_MCMCtree/sum_files_post/withoutArchExclDPANN_GBM_all_mean_est.tsv): this file has the estimated mean posterior divergence times (second column), 2.5% quantile (third column), and 97.5% quantile (fourth column) for those analyses ran under the GBM relaxed-clock model and when node Crown-Archaea excluding DPANN did not have its age constrained. All chains passed the filters, hence why the `FILT` term does not appear in the file name.
  * [**Summary of estimated divergence times | `withoutArchExclDPANN + ILN`**](01_PAML/01_MCMCtree/sum_files_post/withArchExclDPANN_ILN_FILT_all_mean_est.tsv): this file has the estimated mean posterior divergence times (second column), 2.5% quantile (third column), and 97.5% quantile (fourth column) for those analyses ran under the ILN relaxed-clock model and when node Crown-Archaea excluding DPANN did not have its age constrained. Note that some chains had to be filtered out, hence the `FILT` term in the file name.

Please note that each directory has all the data and scripts that you will need to reproduce our analyses if you clone this repository on your PC. Nevertheless, note that the `MCMCtree` output files with all the collected samples during the MCMC that we used to summarise our results are too large to be stored here. If you want to use our results (e.g., compare to the results you get when you re-run our analyses, reproduce our figures or plots, etc.), please download [the GitHub repository from our data archive](.). Depending on how you want to use our step-by-step guidelines, you may do one of the following:

* If you want to run the tutorials under the `01_PAML/01_MCMCtree` to reproduce the results we report in our manuscript, then you will not initially need our output files: you will run PAML programs following our guidelines to generate your own results, which you can analyse with our scripts. Please bear in mind that the your time estimates may vary (i.e., decimals) because you will be using different seed numbers: you will be carrying out independent runs with `MCMCtree`, and such variation is expected (unless the same seed number is used!).
* If you want to either (i) reproduce our figures or plots using our own results or (ii) you have re-run our analysis and want to compare your results to ours, please make sure that you do the following:
  * Download the compressed file with all our timetree inference results from [our data archive)](.). Please note that we may have changed the content of some of the `README.md` files and/or other files since we generated our archive, and so we ask that you use such archive to access the files that you may not find in this repository (due to size limitation) if you need them for the reasons aforementioned. **Please keep an eye on this GitHub repository and our releases to track all the changes/updates since the publication of our paper**.
  * Once downloaded, please decompress the `anoxphoto.zip` file and find the `00_prior` and `01_posterior` directories inside each `01_PAML/01_MCMCtree/sum_analyses` directory. You will see that the `00_prior` and `01_posterior` directories are already inside the `01_PAML/01_MCMCtree` directories that we provide you with in this GitHub repository. Nevertheless, they are all missing the `mcmc.txt` files that you shall find inside the downloaded `00_prior/CLK/*/` and `01_posterior/[GBM|ILN]/*/` directories, which are the output files generated by `MCMCtree` with all the samples collected for each parameter of interest. Our in-house scripts use such files to summarise the results. We recommend that you do the following:
    * If you just want to recreate figures/tables/plots we have included in our paper with our results, please navigate to `01_PAML/01_MCMCtree` in the decompressed file you should have already downloaded, locate the `00_prior` and `01_posterior` directories, and save them in the corresponding `sum_analyses` directories in the file structure you are following as per this repository. Make sure that you save them in the same `01_PAML/01_MCMCtre` directory following the file structure! Then, you can run our scripts to generate the files you wanted.
    * If you want to compare your results to ours, please change the name of your `sum_analyses` directory with your own results so that you do not overwrite your files. Then, you can locate our `sum_analyses` directories in the downloaded archive and place them in the corresponding location in your file structure. You can then re-run our scripts with both your results and ours if you want to also test that you can recreate the same results that we report in our paper.

In a nutshell, if you follow the instructions and run the code snippets and in-house scripts as detailed in each `README.md` file under directories `00_CODEML` and `01_MCMCtree`, you will be able to reproduce all our results! If you have re-run these analyses, then you shall be able to compare your results to ours!

## [In-house scripts](src)

The main scripts that you call when you follow this tutorial are detailed below:

* [fasta-phylip-partitionts.tar.gz](src/fasta-phylip-partitions.tar.gz): this compressed file has the `fasta-phylip-partitions` pipeline that is used to generate the concatenated alignment in PHYLIP format required for PAML programs. Section [`Alignment files` in the `README.md` file](00_data_formatting/README.md#alignment-files) shows how this pipeline is run.
* [Functions.R](src/Functions.R): this script has all the main in-house function we have written to analyse timetree inference results generated with `MCMCtree`. When running the MCMC diagnostics, you will be using those!
* [FASTAtoPHYL.pl](src/FASTAtoPHYL.pl): this script formats FASTA sequence files into PHYLIP sequence files.
* [one_line_fasta.pl](src/one_line_fasta.pl): this script makes sure that there is one line for each sequence in FASTA sequence files.

If you open the scripts aforementioned, you will find all the details regarding the arguments they need and how to run them (which is also referred to when they are called when summarising our results and/or generating output files such as plots or tables).

## What do you need to run our analyses?

### Software

Before you go through this step-by-step tutorial to reproduce our results, please make sure you have the following software installed on your PCs/HPCs:

* **`PAML`**: we used `PAML` v4.10.7, available from the [`PAML` GitHub repository](https://github.com/abacus-gene/paml). Please download [the latest release on the PAML GitHub repository which, as of January 2024, corresponds to the PAML version we used: v4.10.7](https://github.com/abacus-gene/paml/releases/tag/4.10.7). You can use either the pre-compiled binaries for your OS or compile the source code. Note that we used the Linux version to run these analyses on an HPC. Numerical differences may occur depending on the OS where you run this software.

> [!NOTE]
>
> **Linux users**: you may need to install the `intel` compilers before you run `make -f Makefile`. Please visit this link to download the [Intel oneAPI Base Toolkit](https://www.intel.com/content/www/us/en/developer/articles/tool/oneapi-standalone-components.html#dpcpp-cpp).

* **`R`** and **`RStudio`**: please download [R](https://cran.r-project.org/) (i.e., select either `Download R for Linux`, `Download R for macOS`, or `Download R for Windows` depending on your OS; then follow the installation instructions) and [RStudio](https://posit.co/download/rstudio-desktop/) as you will need them to run various of our in-house R scripts. The packages you will need to install work with R versions that are either newer than or equal to v4.1.2 (we used v4.1.2). If you are a Windows user, please make sure that you have the correct version of `RTools` installed, which will allow you to install packages from the source code if required. For instance, if you have R v4.1.2, then installing `RTools4.0` shall be fine. If you have another R version installed on your PC, please check whether you need to install `RTools 4.2` or `RTools 4.3`. For more information on which version you should download, [please go to the CRAN website by following this link and download the version you need](https://cran.r-project.org/bin/windows/Rtools/).

    Before you proceed, however, please make sure that you install the following packages too:

    ```R
    # Run from the R console in RStudio
    # Check that you have at least R v4.1.2
    version$version.string
    # Now, install the packages you will need to run
    # our in-house R scripts
    # Note that it may take a while to install them all
    install.packages( c('rstudioapi', 'ape', 'phytools', 'sn', 'stringr', 'rstan'), dep = TRUE )
    ## NOTE: If you are a Windows user and see the message "Do you want to install from sources the 
    ## packages which need compilarion?", please make sure that you have installed the `RTools`
    ## aforementioned. Otherwise, you will get errors during the installation.
    ## The versions we used for each of the packages aforementioned are the following:
    ##   rstudioapi: v0.14
    ##   ape: v5.7.1
    ##   phytools: v1.5.1
    ##   sn: v2.1.1
    ##   stringr: v1.5.0
    ##   rstan: v2.21.7
    ```
  
> [!NOTE]
>
> **Linux users**: you may experience some problems when you try to execute the `install.packages()` command that you see in the code snippet above. If that is the case, please install each package separately (e.g., `install.packages( 'rstudioapi' )` to install `rstudioapi`, etc.). If you experience problems with `stringr`, please follow the [suggestions given in this StackOverflow page](https://stackoverflow.com/questions/38987157/libicu-and-stringi-on-fedora-24-causing-r-headaches/39411793#39411793) -- despite the question being addressed for Fedora, the solution suggested also works for Ubuntu.

* **`TreeViewer`**: you can use `TreeViewer` ([Bianchini and Sánchez-Baracaldo, 2024](https://onlinelibrary.wiley.com/doi/10.1002/ece3.10873)) as a graphical interface with which you can display and highly customise the format of the timetrees we have generated and include in this repository. You may want to read [the `TreeViewer` documentation](https://github.com/arklumpus/TreeViewer/wiki) to learn more about which modules you can use and how you can improve the design of your timetrees (e.g., include/exclude densities, include pictures, play with various colours and shapes, etc.). You can [download `TreeViewer` by following this link](https://treeviewer.org/).

* **`FigTree`**: alternatively, you can use `FigTree` to display the timetrees we have generated. While not as customisable as `TreeViewer`, you can decide what you want to be displayed on the graphical interface by selecting the buttons and options that enable a specific design. You can [download the latest pre-compiled binaries, `FigTree v1.4.4`, from the `FigTree` GitHub repository](https://github.com/rambaut/figtree/releases).

* **`Tracer`**: you can use this graphical interface to visually assess the MCMCs you have run during your analyses (e.g., chain efficiency, chain convergence, autocorrelation, etc.). You can [download the latest pre-compiled binaries, `Tracer v1.7.2`, from the `Tracer` GitHub repository](https://github.com/beast-dev/tracer/releases/tag/v1.7.2).

### Additional note for Mac users when using the `sed` command

If you are running a UNIX-based system (e.g., Mac users), you will experience some problems with the Linux-based `sed` command that you shall see (i) in the various code snippets that you need to run as part of the tutorial described in this repository and (ii) used in most of our in-house bash scripts. By default, this command is different from Linux-based systems, and hence you will have problems to execute it as intended unless you follow one of these two approaches:

* (EASY): Instead of running the `sed` commands using the format `sed -i 's/PATTERN/REPLACEMENT/'` (i.e., what you shall see in the code snippets), you should include `''` between `-i` and `'s/PATTERN/REPLACEMENT/'`: `sed -i '' 's/PATTERN/REPLACEMENT/'`. Please remember to modify the commands in this tutorial accordingly before you copy and paste them on your terminal!
* (MORE DIFFICULT): You should install `GNU sed` and establish it as the "standard" `sed` command instead of the one you will have by default. At the time of writing, [this post](https://medium.com/@bramblexu/install-gnu-sed-on-mac-os-and-set-it-as-default-7c17ef1b8f64) is available and has a detailed explanation that you could follow to install `GNU sed`. Nevertheless, there are many other tutorials out there that you can follow to achieve the same goal. If you decide to follow this approach, you will not need to change the commands in this tutorial!

Once the `sed` incompatibility is sorted out, there should not be any problems with regards to following this tutorial and/or running our in-house bash scripts!

<br>

----

<br>

If you have gone through the previous sections and have a clear understanding of the data we used, the workflow we followed (which you shall follow to reproduce our analyses), and have installed the required software aforementioned... Then you are ready to go!

You can start by taking a look at how we formatted the raw dataset with which we started the timetree inference analyses [by following this link](00_data_formatting/README.md).

Happy timetree inference! :)

## Contact

This repository and its content was created by **Dr Sandra Álvarez-Carretero** ([`@sabifo4`](https://github.com/sabifo4/)), who actively maintains this repository too. If you have any queries with regards to the analyses detailed in this repository, please do not hesitate to <a href="mailto:sandra.ac93@gmail.com">reach me via email</a>!